name: Test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test-versions:
    name: Mosquitto ${{ matrix.mosquitto_version }} on ${{ matrix.platform }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        mosquitto_version:
          - '2.0.18'
          - '2.0.22'
        platform:
          - linux/amd64
          - linux/arm64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        run: |
          PLATFORM_PAIR=$(echo "${{ matrix.platform }}" | tr / -)
          echo "platform-pair=${PLATFORM_PAIR}" >> $GITHUB_OUTPUT
          MOSQUITTO_VERSION_TAG=$(echo "${{ matrix.mosquitto_version }}" | tr . -)
          echo "mosquitto-version-tag=${MOSQUITTO_VERSION_TAG}" >> $GITHUB_OUTPUT

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: ${{ matrix.platform }}
          build-args: |
            MOSQUITTO_VERSION=${{ matrix.mosquitto_version }}
            LWS_VERSION=4.3.3
          push: false
          tags: mosquitto-go-auth:test-v${{ steps.meta.outputs.mosquitto-version-tag }}-${{ steps.meta.outputs.platform-pair }}
          cache-from: type=gha,scope=test-${{ matrix.mosquitto_version }}-${{ matrix.platform }}
          cache-to: type=gha,mode=max,scope=test-${{ matrix.mosquitto_version }}-${{ matrix.platform }}
          load: true

      - name: Test Mosquitto version
        run: |
          docker run --rm --platform ${{ matrix.platform }} \
            mosquitto-go-auth:test-v${{ steps.meta.outputs.mosquitto-version-tag }}-${{ steps.meta.outputs.platform-pair }} \
            /usr/sbin/mosquitto -h | head -n 5
          
          echo "✅ Mosquitto ${{ matrix.mosquitto_version }} on ${{ matrix.platform }} works!"

      - name: Test plugin loading
        run: |
          # Create a minimal test config
          cat > /tmp/test-mosquitto.conf << 'EOF'
          listener 1883
          allow_anonymous false
          auth_plugin /mosquitto/go-auth.so
          EOF
          
          # Try to start mosquitto with the plugin (it will fail without proper config, but should load the plugin)
          docker run --rm --platform ${{ matrix.platform }} \
            -v /tmp/test-mosquitto.conf:/etc/mosquitto/mosquitto.conf \
            mosquitto-go-auth:test-v${{ steps.meta.outputs.mosquitto-version-tag }}-${{ steps.meta.outputs.platform-pair }} \
            /usr/sbin/mosquitto -c /etc/mosquitto/mosquitto.conf -v || true
          
          echo "✅ Plugin loading test completed for Mosquitto ${{ matrix.mosquitto_version }}"

  integration-test:
    name: Integration Test - Mosquitto ${{ matrix.mosquitto_version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        mosquitto_version:
          - '1.6.15'
          - '2.0.18'
          - '2.0.22'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set Mosquitto version in Dockerfile.runtest
        run: sed -i 's/ARG MOSQUITTO_VERSION=1.6.14/ARG MOSQUITTO_VERSION=${{ matrix.mosquitto_version }}/' Dockerfile.runtest

      - name: Build test image
        run: docker build -t mosquitto-go-auth.test -f Dockerfile.runtest .

      - name: Run integration tests
        run: docker run --rm mosquitto-go-auth.test ./run-test-in-docker.sh

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-versions, integration-test]
    if: always()
    
    steps:
      - name: Create summary
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Compatibility Tests" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ needs.test-versions.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Mosquitto 2.0.18, 2.0.22" >> $GITHUB_STEP_SUMMARY
          echo "- Platforms: linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ needs.integration-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Mosquitto 1.6.15 (1.x), 2.0.18 (2.x)" >> $GITHUB_STEP_SUMMARY
          echo "- Full test suite with all backends" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test-versions.result }}" != "success" ] || [ "${{ needs.integration-test.result }}" != "success" ]; then
            echo "❌ Some tests failed. Check the logs above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "✅ All tests passed!" >> $GITHUB_STEP_SUMMARY